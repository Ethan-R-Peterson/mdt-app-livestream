<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MDT Livestream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h1>MDT Livestream MVP</h1>

  <!-- Controls -->
  <div style="margin:8px 0;">
    <label>Source:
      <select id="sourceSel">
        <option value="rgb_hls">RGB (HLS)</option>
        <option value="thermal_hls">Thermal (HLS)</option>
        <option value="thermal_mjpeg">Thermal (MJPEG)</option>
        <option value="test_hls">Test (HLS)</option>
      </select>
    </label>
    <button id="loadBtn">Load Source</button>

    <label style="margin-left:12px;">Telemetry WS:
      <input id="wsUrl" size="40" />
    </label>
    <button id="wsBtn">Connect Telemetry</button>
  </div>

  <!-- Video (HLS/WebRTC later) + overlay -->
  <div id="video-wrap" style="position:relative; display:inline-block;">
    <video id="video" playsinline autoplay muted controls style="width: 800px; background:#000;"></video>
    <canvas id="overlay" width="800" height="450"
            style="position:absolute; left:0; top:0; pointer-events:none;"></canvas>
  </div>

  <!-- Thermal MJPEG fallback -->
  <div id="mjpeg-wrap" style="display:none;">
    <img id="mjpeg" alt="thermal stream" style="width:800px; background:#000;" />
  </div>

  <!-- Telemetry readout -->
  <pre id="telemetry" style="border:1px solid #ccc; padding:8px; width:800px; height:140px; overflow:auto; margin-top:8px;"></pre>

  <!-- Map mount point (Siddhant plugs in here later) -->
  <div id="map" style="width:800px;height:400px;margin-top:8px;border:1px dashed #aaa;display:flex;align-items:center;justify-content:center;">
    <span style="opacity:0.6;">Map placeholder — Siddhant mounts here</span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    // --- light event bus so map/other modules can subscribe to telemetry ---
    const Bus = {
      subs: {},
      on(evt, fn){ (this.subs[evt] ??= []).push(fn); },
      emit(evt, data){ (this.subs[evt]||[]).forEach(fn=>fn(data)); }
    };

    const cfg = { sources:{}, telemetry_ws:"" };
    const els = {
      video: document.getElementById('video'),
      overlay: document.getElementById('overlay'),
      overlayCtx: document.getElementById('overlay').getContext('2d'),
      telemetry: document.getElementById('telemetry'),
      srcSel: document.getElementById('sourceSel'),
      loadBtn: document.getElementById('loadBtn'),
      wsUrl: document.getElementById('wsUrl'),
      wsBtn: document.getElementById('wsBtn'),
      mjpegWrap: document.getElementById('mjpeg-wrap'),
      mjpeg: document.getElementById('mjpeg'),
      videoWrap: document.getElementById('video-wrap'),
    };

    let hls = null, ws = null;

    // --- config loader ---
    async function loadConfig(){
      try{
        const r = await fetch('config.json', {cache:'no-store'});
        const j = await r.json();
        Object.assign(cfg, j);
        els.wsUrl.value = cfg.telemetry_ws || '';
      }catch(e){
        console.warn('No config.json found or invalid JSON, using defaults');
      }
    }

    // --- video loaders ---
    function playHls(url){
      els.mjpegWrap.style.display = 'none';
      els.videoWrap.style.display = 'inline-block';
      if (hls){ hls.destroy(); hls = null; }
      if (Hls.isSupported()){
        hls = new Hls({ liveSyncDurationCount: 2 });
        hls.loadSource(url);
        hls.attachMedia(els.video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => els.video.play());
      } else if (els.video.canPlayType('application/vnd.apple.mpegurl')){
        els.video.src = url; // Safari
        els.video.play();
      } else {
        alert('HLS not supported in this browser.');
      }
    }
    function showMjpeg(url){
      if (hls){ hls.destroy(); hls = null; }
      els.videoWrap.style.display = 'none';
      els.mjpegWrap.style.display = 'block';
      els.mjpeg.src = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now(); // bust cache
    }

    // --- overlay drawing from telemetry dets[] ---
    function drawOverlay(d){
      const ctx = els.overlayCtx, c = ctx.canvas;
      ctx.clearRect(0,0,c.width,c.height);
      if (!Array.isArray(d?.dets)) return;
      ctx.lineWidth = 2;
      ctx.font = '14px monospace';
      d.dets.forEach(b=>{
        const x = Math.round((b.x||0)*c.width);
        const y = Math.round((b.y||0)*c.height);
        const w = Math.round((b.w||0)*c.width);
        const h = Math.round((b.h||0)*c.height);
        ctx.strokeRect(x,y,w,h);
        const label = `${b.label ?? 'obj'} ${Math.round((b.conf??0)*100)}%`;
        ctx.fillText(label, x+4, y+16);
      });
    }

    // --- telemetry websocket ---
    function connectWs(url){
      if (ws) ws.close();
      ws = new WebSocket(url);
      log(`WS connecting: ${url}`);
      ws.onopen = ()=>log('WS connected');
      ws.onclose = ()=>log('WS closed');
      ws.onerror = (e)=>log('WS error');
      ws.onmessage = (msg)=>{
        try{
          const d = JSON.parse(msg.data);
          Bus.emit('telemetry', d);   // let map subscribe later
          renderTelemetry(d);
          drawOverlay(d);
        }catch(e){
          log('Bad JSON: ' + msg.data);
        }
      };
    }

    function log(text){
      els.telemetry.textContent += text + '\n';
      els.telemetry.scrollTop = els.telemetry.scrollHeight;
    }

    function renderTelemetry(d){
      const lines = [
        `t=${d.time ?? ''}`,
        `lat=${d.lat ?? ''}, lon=${d.lon ?? ''}`,
        `alt=${fmt(d.alt)} m, gs=${fmt(d.gs)} m/s`,
        `batt=${d.batt ?? ''}%`,
        `yaw=${d.yaw ?? ''}°, pitch=${d.pitch ?? ''}°, roll=${d.roll ?? ''}`
      ].filter(Boolean);
      log(lines.join(' | '));
    }
    const fmt = x => (typeof x==='number' && x.toFixed) ? x.toFixed(2) : x;

    // --- UI events ---
    els.loadBtn.addEventListener('click', ()=>{
      const key = els.srcSel.value;
      const url = cfg.sources?.[key];
      if (!url) return alert('No URL configured for '+key);
      if (key.includes('mjpeg')) showMjpeg(url);
      else playHls(url);
    });
    els.wsBtn.addEventListener('click', ()=>{
      const url = els.wsUrl.value.trim();
      if (!url) return alert('Enter WS URL');
      connectWs(url);
    });

    // boot
    (async function(){
      await loadConfig();
      // preload default
      if (cfg.sources?.rgb_hls) playHls(cfg.sources.rgb_hls);
      if (cfg.telemetry_ws) connectWs(cfg.telemetry_ws);

      // Example of how Siddhant would subscribe:
      Bus.on('telemetry', (d)=>{
        // e.g., map.updatePose(d.lat, d.lon, d.yaw)
      });
    })();
  </script>
</body>
</html>
